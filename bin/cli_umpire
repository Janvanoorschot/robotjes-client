#!/usr/bin/env python3

import sys, os
import argparse
import asyncio

import config
import client

rootdir = os.path.abspath(os.path.join(os.path.dirname(__file__), os.pardir))
sys.path.append(rootdir)

# get commandline arguments
parser = argparse.ArgumentParser(description='CommandLineInterface (CLI) for Umpire')
parser.add_argument('--url', type=str, default=config.REST_URL, help='url of the robotjes REST entrypoint')
parser.add_argument('--umpire', type=str, default="me", help='name or id of the umpire')
parser.add_argument('--name', type=str, default="game1", help='name of the game to create')
parser.add_argument('--password', type=str, default="secret1", help='password needed to enter the game')
parser.add_argument('--maze', type=str, default="default", help='name of the maze to use')
args = parser.parse_args()


class Timer:
    def __init__(self, timeout, callback, repeat=False):
        self.timeout = timeout
        self.callback = callback
        self.repeat = repeat
        self.task = asyncio.ensure_future(self.job())

    async def job(self):
        await asyncio.sleep(self.timeout)
        await self.callback()
        if self.repeat:
            self.task = asyncio.ensure_future(self.job())

    def cancel(self):
        self.task.cancel()

class Umpire_Client:

    def __init__(self):
        pass

    def registered(self, game_id, game_name):
        print(f"game registered: {game_id}")

    def discovered(self, game_id):
        print(f"game discovered: {game_id}")

    def player_registered(self, player_id, player_name):
        print(f"player registered: {player_id}/{player_name}")

    def player_deregistered(self, player_id, player_name):
        print(f"player deregistered: {player_id}/{player_name}")

    def started(self):
        print(f"game started")

    def stopped(self, success):
        print(f"game stopped: {success}")

    def game_status(self, game_tick, game_status):
        pass

    def player_status(self, game_tick, player_status):
        pass

    def tick(self, tick):
        # print(f"tick: {tick}")
        pass

    def game_tick(self, game_tick):
        # print(f"cli_umpire/game_timer[{game_tick}]")
        pass


async def main(loop):
    clnt = Umpire_Client()
    umpire = client.CLIUmpire(loop, args.url, clnt)
    timer = Timer(0.5, umpire.timer, True)
    await umpire.run_game(args.umpire, args.name, args.password, args.maze)
    timer.cancel()

# run our main loop
aloop = asyncio.get_event_loop()
aloop.run_until_complete(main(aloop))
aloop.stop()
